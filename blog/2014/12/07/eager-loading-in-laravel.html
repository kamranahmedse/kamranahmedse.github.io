<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="viewport"
          content="width=device-width, user-scalable=yes, initial-scale=1.0, maximum-scale=3.0, minimum-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Eager Loading in Laravel</title>
    <meta name="description" content="Blog of a Software Engineer"/>
    <meta name="keywords" content="blog,developer blog,engineering blog"/>

    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Alegreya:400,400i|Lato:400,400i,700,900|Roboto+Mono:400,300">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/shades-of-purple.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>

    <link rel="stylesheet" href="/css/normalize.css"/>
    <link rel="stylesheet" href="/css/theme.css"/>
</head>
<body>
<nav class="nav">
    <div class="nav__left">
        <a href="/">Home</a>
        <a href="/about">About</a>
    </div>
    <div class="nav__right">
        <a target="_blank" href="https://github.com/kamranahmedse" class="link-github">GitHub</a>
        <a target="_blank" href="https://twitter.com/kamranahmedse" class="link-twitter">Twitter</a>
        <a href="mailto:kamranahmed.se@gmail.com" class="link-email">Email</a>
    </div>
</nav>

<article class="mar-b-7">
    <header class="text-center">
        <time class="mar-b-6" datetime="Sun, December 07, 2014">Sun, December 07, 2014</time>
        <h1 class="mar-b-7">Eager Loading in Laravel</h1>
    </header>
    <p>Laravel comes with a powerful ORM i.e. Eloquent. While it gives you a lot of power, it is to be used with care as it can completely hide the fact that you might be using it to write completely inefficient queries. You will never want to wake up in the morning one day, finding out that your application has been hosed because of some query that you wrote and it killed the database.</p>
<p>In this article, I am going to be writing about the eager loading in Laravel 4 and how can it be used to tackle the inefficient database queries. To be more specific, I'll be writing about N+1 problem with eager loading. First things first, let's discuss what N+1 problem actually is.</p>
<h1 id="n1problem">N+1 Problem</h1>
<p>N+1 problem is related to the inefficient queries i.e. running one query and then running N queries for the records returned by that first query ..didn't understand? No worries, you'll understand it in a moment.</p>
<p>Let's say we are developing that web based library management system for one of those colleges where under every stone lurks a student. In your database, we have got <em>two tables</em>, to make things simple, let's say <code>students</code> and <code>books</code>. As you can guess, there is one to many relation between both the tables as one student can have many books. Suppose, we want to get all the students and their books and we write the following SQL Statements to do so</p>
<pre><code class="sql language-sql">-- Select all the students
SELECT * FROM students;

-- Through a loop over the students you got from the above query, you get the books
SELECT * FROM books WHERE student_id = ?
</code></pre>
<p>The above query alleviates the N+1 problem i.e. firstly, there is <code>one</code> select statement to get the students and then N additional selects for the books, where N is the number of students. In case of a large number of students and books as in our case, performance hit would be really significant. Now, above were just simple SQL statements so it was easy for us to guess the trap that we were setting for ourselves. </p>
<p>Let's say our system is being developed on top of Laravel and we have used it's awesome Eloquent ORM to aid us in the development. We have got two models i.e. <code>Student</code> and <code>Book</code> and the relationship between <code>Student</code> and the book is as follows:</p>
<pre><code class="php language-php">// Model : Student
public function books(){
    $this-&gt;hasMany('Book');
}
</code></pre>
<p>Now as we wanted to get all the students and the books they have got issued, using eloquent, we might be tempted to do the following:</p>
<pre><code class="php language-php">$students = Student::all();
foreach( $students as $student ) {
    echo $student-&gt;name;    
    $books = $student-&gt;books;
    // Do someting with the $books
}
</code></pre>
<p>It will work exactly how it is intended to work that is, it will get us the students and foreach of the students it will get us the books we want. From the above snippet, there doesn't seem to be anothing wrong with this code, but let's see what's going on under the hood. </p>
<p>Below are the queries that will be executed for this:</p>
<pre><code class="sql language-sql">-- Select the students i.e. Student::all();
SELECT * FROM students;

-- Foreach of the students, another query to select the books
-- i.e. $student-&gt;books part of the loop
SELECT * FROM books WHERE student_id = 1
SELECT * FROM books WHERE student_id = 2
SELECT * FROM books WHERE student_id = 3
SELECT * FROM books WHERE student_id = 4
SELECT * FROM books WHERE student_id = 5
SELECT * FROM books WHERE student_id = 6
SELECT * FROM books WHERE student_id = 7
SELECT * FROM books WHERE student_id = 8
...
</code></pre>
<p>Notice how inefficient it will be in our case. Let's say we have got 1000 students then there will be 1 query to get the students then one query for each of students to get the books so there will be 1000+1 queries (thus N+1 problem) while we <em>might have</em> written two queries to handle this</p>
<pre><code class="sql language-sql">SELECT * FROM students;
SELECT * FROM books WHERE student_id IN (1,2,3,4,5,6,7,8..);
</code></pre>
<h1 id="eagerloading">Eager Loading</h1>
<p>Eager loading is how Laravel allows us to tackle the N+1 problem. It lets us specify the records that we need pre-hand resulting in more efficient database queries. Let me explain it with the example stated above. Assuming that the relationship between the <code>Student</code> and <code>Book</code> as stated above is in place, to avail eager loading we will have to modify our above statements as follows</p>
<pre><code class="php language-php">$students = Student::with('books')-&gt;get();
foreach( $students as $student ) {
    echo $student-&gt;name;    
    $books = $student-&gt;books;
    // Do someting with the $books
}
</code></pre>
<p>What we are doing here by <code>Student::with('books')-&gt;get();</code> is letting Laravel know that we will need <code>books</code> for the students as well so make sure to load them <code>with</code> books. After making use of this, Laravel will be executing two queries i.e.</p>
<pre><code class="sql language-sql">SELECT * FROM students;
SELECT * FROM books WHERE student_id IN (1,2,3,4,5,6,7,8..);
</code></pre>
<p>As you can see, while making use of Laravel's eager loading, a slight modification in our retrieval process has allowed us to make our queries efficient i.e. contrary to the previously stated way in which there were N queries for N records retruned by our first query, we will only be executing two queries to get whatever number of students we have in our database.</p>
<p>In different scenarios, you might need to eager load differently. Below, I state some of the ways that you can use to get the most out of eager loading.</p>
<p>If you want, you can <strong>eager load multiple relations</strong> at one time, for example let's say if we have <code>books</code> as well as <code>classes</code> in a <code>Student</code>, we might do the following to eager load all the <code>books</code> and <code>classes</code></p>
<pre><code class="php language-php">$students = Student::with('books', 'classes')-&gt;get();
foreach( $students as $student ) {
    echo $student-&gt;name;    
    $books = $student-&gt;books;
    $classes = $student-&gt;classes();
    // Do someting with the $books/$classes
}
</code></pre>
<p>You may even <strong>eager load nested relationships</strong>. Extending from our last example, let's our <code>Book</code> model is further related to <code>Author</code>, we may do the following to eager load the <code>students</code>, <code>books</code> and the <code>authors</code> of those books</p>
<pre><code class="php language-php">$students = Student::with('books.authors')-&gt;get();
foreach( $students as $student ) {
    echo $student-&gt;name;
    $books = $student-&gt;books;

    foreach ( $books as $book )
    {
        $authors = $book-&gt;authors;
    }
}
</code></pre>
<p>Laravel also allows you to eager load with constraints so that you may not get all the records when you only want some. Proceeding with the previously stated examples, lets say we want all the students and the books but only those books that have the <code>status</code> set to <code>returned</code>, we'll do the following</p>
<pre><code class="php language-php">$students = Student::with(array('books' =&gt; function( $query ){
    $query-&gt;where('status', '=', 'returned');
}))-&gt;get();

foreach( $students as $student ) {
    echo $student-&gt;name;    
    $books = $student-&gt;books;
    // Do someting with the $books
}
</code></pre>
<p>In the above example we'll be loading only those books that have the <code>status</code> set to <code>returned</code>.</p>
<h1 id="finalwords">Final Words</h1>
<p>I hope you would have understood the N+1 problem and eager loading in Laravel by now. I encourage you to use eager loading whenever possible to make your database queries more robust. If you have any questions please do not hesitate to ask them by posting them in the comment section below.</p>
</article>


    <section id="mc_embed_signup" class="mar-tb-7 twitter-signup">
        <div class="mc-title-container"></div>

        <p class="mar-0 twitter-signup-text">ðŸ‘‹ <a href="http://twitter.com/kamranahmedse"
                                                   target="_blank">Follow me on
                twitter</a> for the updates. </p>
    </section>


<footer class="text-center mar-tb-6">
    Â© 2023 Kamran Ahmed, unless otherwise stated.
</footer>

<script>hljs.highlightAll();</script>
</body>
</html>

